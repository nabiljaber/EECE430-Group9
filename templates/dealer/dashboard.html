{% extends "base.html" %}
{% block content %}
<h1>Welcome, {{ request.user.first_name|default:request.user.username }}</h1>

<!-- Metrics row -->
<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
  <div class="card">
    <div class="muted">Cars</div>
    <h2>{{ cars|length }}</h2>
  </div>
  <div class="card">
    <div class="muted">This month bookings</div>
    <h2>{{ metrics.bookings_count|default:0 }}</h2>
  </div>
  <div class="card">
    <div class="muted">This month revenue</div>
    <h2>${{ metrics.revenue|default:0 }}</h2>
  </div>
  <div class="card">
    <div class="muted">Period</div>
    <h2>{{ month_start|date:"M Y" }}</h2>
  </div>
  <div class="card" style="display:flex;align-items:center;justify-content:flex-end">
    <a class="btn btn-primary" href="{% url 'dealer_add_car' %}">Add car</a>
  </div>
  
</div>

<!-- Cars table with availability -->
<div class="card mt-3" style="overflow-x:auto">
  <table class="table">
    <thead>
      <tr>
        <th>Car</th>
        <th>Specs</th>
        <th>Price/day</th>
        <th>Status</th>
        <th class="right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for car in cars %}
      <tr>
        <td><a href="{% url 'car_detail' car.id %}">{{ car.title }}</a><div class="muted">Added {{ car.created_at|date:"Y-m-d" }}</div></td>
        <td>{{ car.make }} {{ car.model }} {{ car.year }} · {{ car.get_transmission_display }} · {{ car.seats }} seats</td>
        <td>${{ car.price_per_day }} {{ car.currency }}</td>
        <td>
          {% if car.current_booking %}
            <span class="chip" style="color:#ffb4c0;border-color:#55181f;background:#2a0f13">Booked until {{ car.current_booking.end_date }}</span>
          {% elif car.next_booking %}
            <span class="chip">Next: {{ car.next_booking.start_date }} → {{ car.next_booking.end_date }}</span>
          {% else %}
            <span class="chip" style="color:#b4ffd2;border-color:#1f5531;background:#0f2a1a">Available</span>
          {% endif %}
        </td>
        <td class="right">
          <a class="btn btn-secondary" href="{% url 'dealer_edit_car' car.id %}">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="muted">No cars yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- This month bookings -->
<div class="card mt-3" style="overflow-x:auto">
  <h3>This month bookings</h3>
  <table class="table mt-2">
    <thead>
      <tr>
        <th>Car</th>
        <th>Customer</th>
        <th>Dates</th>
        <th>Status</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {% for b in month_bookings %}
      <tr>
        <td><a href="{% url 'car_detail' b.car.id %}">{{ b.car.title }}</a></td>
        <td>{{ b.user.username }}</td>
        <td>{{ b.start_date }} → {{ b.end_date }}</td>
        <td>{{ b.status|title }}</td>
        <td>${{ b.total_price|default:0 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="muted">No bookings this month.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Schedules (mini calendars) -->
<div class="mt-3">
  <h3>Schedules ({{ month_start|date:"F Y" }})</h3>
  <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
    {% for car in cars %}
      <div class="card">
        <h4 style="margin-bottom:8px;">{{ car.title }}</h4>
        <div class="mini-cal">
          <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
          {% for week in car.calendar_weeks %}
            {% for d in week %}
              <div class="day{% if not d.in_month %} dim{% endif %}{% if d.booked %} booked{% endif %}{% if d.today %} today{% endif %}">
                {{ d.date.day }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px;">Green = Available · Red = Booked</div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
