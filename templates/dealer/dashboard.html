{% extends "base.html" %}
{% block content %}
<h1>Welcome, {{ request.user.first_name|default:request.user.username }}</h1>

<!-- Metrics row -->
<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
  <div class="card">
    <div class="muted">Cars</div>
    <h2>{{ cars|length }}</h2>
  </div>
  <div class="card">
    <div class="muted">This month bookings</div>
    <h2>{{ metrics.bookings_count|default:0 }}</h2>
  </div>
  <div class="card">
    <div class="muted">Pending approvals</div>
    <h2>{{ metrics.pending|default:0 }}</h2>
  </div>
  <div class="card">
    <div class="muted">Confirmed revenue</div>
    <h2>${{ metrics.revenue|default:0 }}</h2>
  </div>
  <div class="card">
    <div class="muted">Period</div>
    <h2>{{ month_start|date:"M Y" }}</h2>
  </div>
  <div class="card" style="display:flex;align-items:center;justify-content:flex-end">
    <a class="btn btn-primary" href="{% url 'dealer_add_car' %}">Add car</a>
  </div>
  
</div>

<!-- Cars table with availability -->
<div class="card mt-3" style="overflow-x:auto">
  <table class="table">
    <thead>
      <tr>
        <th>Car</th>
        <th>Specs</th>
        <th>Price/day</th>
        <th>Revenue</th>
        <th>Status</th>
        <th>Next booking</th>
        <th class="right">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for car in cars %}
      <tr>
        <td>
          <a href="{% url 'car_detail' car.id %}">{{ car.title }}</a>
          <div class="muted">Added {{ car.created_at|date:"Y-m-d" }}</div>
        </td>
        <td>{{ car.make }} {{ car.model }} {{ car.year }} | {{ car.get_transmission_display }} | {{ car.seats }} seats</td>
        <td>${{ car.price_per_day }} {{ car.currency }}</td>
        <td>
          <strong>${{ car.confirmed_revenue|default_if_none:0|floatformat:2 }}</strong>
          <div class="muted">{{ car.confirmed_bookings|default:0 }} confirmed</div>
        </td>
        <td>
          {% if car.current_booking %}
            <span class="chip" style="color:#ffb4c0;border-color:#55181f;background:#2a0f13">Booked until {{ car.current_booking.end_date }}</span>
          {% elif car.next_booking %}
            <span class="chip">Next: {{ car.next_booking.start_date }} - {{ car.next_booking.end_date }}</span>
          {% else %}
            <span class="chip" style="color:#b4ffd2;border-color:#1f5531;background:#0f2a1a">Available</span>
          {% endif %}
        </td>
        <td>
          {% if car.next_booking %}
            <div>
              <strong>{{ car.next_booking.user.get_full_name|default:car.next_booking.user.username }}</strong>
              <div class="muted">{{ car.next_booking.start_date }} - {{ car.next_booking.end_date }}</div>
              <div class="muted">${{ car.next_booking.total_price|default:0 }}</div>
            </div>
            <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
              {% if car.next_booking.status|lower == "pending" %}
                <form method="post" action="{% url 'dealer_update_booking_status' car.next_booking.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="confirm">
                  <button class="btn btn-primary btn-sm">Confirm</button>
                </form>
                <form method="post" action="{% url 'dealer_update_booking_status' car.next_booking.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="cancel">
                  <button class="btn btn-outline btn-sm">Reject</button>
                </form>
              {% else %}
                <span class="muted">Status: {{ car.next_booking.get_status_display }}</span>
              {% endif %}
              {% if car.next_booking.user.email %}
                <a class="btn btn-secondary btn-sm" href="mailto:{{ car.next_booking.user.email }}?subject=Booking for {{ car.title }}">Message</a>
              {% endif %}
            </div>
          {% else %}
            <div class="muted">No upcoming bookings.</div>
          {% endif %}
        </td>
        <td class="right" style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;">
          <a class="btn btn-secondary" href="{% url 'dealer_car_bookings' car.id %}">Manage</a>
          <a class="btn btn-outline icon-btn" href="{% url 'dealer_car_bookings' car.id %}#calendar" title="View schedule">
            <span aria-hidden="true">&#128197;</span>
          </a>
          <a class="btn btn-outline" href="{% url 'dealer_edit_car' car.id %}">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="muted">No cars yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pending reservations -->
<div class="card mt-3" style="overflow-x:auto">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
    <div>
      <h3>Pending reservations</h3>
      <p class="muted" style="margin:4px 0 0;">Approve or decline incoming customer requests from here.</p>
    </div>
  </div>
  {% if pending_bookings %}
    <table class="table mt-2">
      <thead>
        <tr>
          <th>Car</th>
          <th>Customer</th>
          <th>Dates</th>
          <th>Total</th>
          <th class="right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for b in pending_bookings %}
        <tr>
          <td><a href="{% url 'car_detail' b.car.id %}">{{ b.car.title }}</a></td>
          <td>{{ b.user.get_full_name|default:b.user.username }}</td>
          <td>{{ b.start_date }} - {{ b.end_date }}</td>
          <td>${{ b.total_price|default:0 }}</td>
          <td class="right">
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
              <form method="post" action="{% url 'dealer_update_booking_status' b.id %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="confirm">
                <button class="btn btn-primary btn-sm">Accept</button>
              </form>
              <form method="post" action="{% url 'dealer_update_booking_status' b.id %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="cancel">
                <button class="btn btn-outline btn-sm">Reject</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted" style="margin-top:12px;">There are no pending reservations.</p>
  {% endif %}
</div>

<!-- This month bookings -->
<div class="card mt-3" style="overflow-x:auto">
  <h3>This month bookings</h3>
  <table class="table mt-2">
    <thead>
      <tr>
        <th>Car</th>
        <th>Customer</th>
        <th>Dates</th>
        <th>Status</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for b in month_bookings %}
      <tr>
        <td><a href="{% url 'car_detail' b.car.id %}">{{ b.car.title }}</a></td>
        <td>{{ b.user.username }}</td>
        <td>{{ b.start_date }} - {{ b.end_date }}</td>
        <td>{{ b.status|title }}</td>
        <td>${{ b.total_price|default:0 }}</td>
        <td>
          {% if b.status|lower == "pending" %}
            <form method="post" action="{% url 'dealer_update_booking_status' b.id %}" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="confirm">
              <button class="btn btn-primary btn-sm" style="margin-bottom:4px;">Confirm</button>
            </form>
            <form method="post" action="{% url 'dealer_update_booking_status' b.id %}" style="display:inline;">
              {% csrf_token %}
              <input type="hidden" name="action" value="cancel">
              <button class="btn btn-outline btn-sm">Cancel</button>
            </form>
          {% else %}
            <span class="muted">--</span>
          {% endif %}
          {% if b.user.email %}
            <a class="btn btn-secondary btn-sm" style="margin-left:6px;" href="mailto:{{ b.user.email }}?subject=Booking for {{ b.car.title }}">Message</a>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="muted">No bookings this month.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Collapsible per-car schedules -->
<div class="card mt-3">
  <h3>Car schedules</h3>
  <p class="muted" style="margin:4px 0 0;">Click a vehicle to view its availability calendar and upcoming trips.</p>
  {% if cars %}
    <div style="margin-top:16px;display:flex;flex-direction:column;gap:12px;">
      {% for car in cars %}
        <details class="car-schedule" data-car-schedule>
          <summary class="car-schedule-summary" style="cursor:pointer;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;background:#0f1828;">
            <div>
              <div style="font-weight:600;">{{ car.title }}</div>
              <div class="muted" style="margin-top:4px;">
                {% if car.current_booking %}
                  In trip until {{ car.current_booking.end_date }}
                {% elif car.next_booking %}
                  Next booking: {{ car.next_booking.start_date }} - {{ car.next_booking.end_date }}
                {% else %}
                  No upcoming bookings
                {% endif %}
              </div>
            </div>
            <span class="muted" style="font-size:12px;white-space:nowrap;">Click to toggle</span>
          </summary>
          <div class="schedule-body" style="margin:12px 0 0;padding:12px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;">
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;">
              <div>
                <h4 style="margin:0;">{{ month_start|date:"F Y" }} calendar</h4>
                <div class="mini-cal mt-2">
                  <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
                  {% for week in car.calendar_weeks %}
                    {% for d in week %}
                      <div class="day{% if not d.in_month %} dim{% endif %}{% if d.booked %} booked{% endif %}{% if d.today %} today{% endif %}">
                        {{ d.date.day }}
                      </div>
                    {% endfor %}
                  {% endfor %}
                </div>
                <p class="muted" style="font-size:12px;margin-top:8px;">Green = available &nbsp;&nbsp; Red = reserved</p>
              </div>
              <div>
                <h4 style="margin:0;">Upcoming trips</h4>
                {% if car.upcoming_bookings %}
                  <ul style="list-style:none;margin:12px 0 0;padding:0;display:flex;flex-direction:column;gap:10px;">
                    {% for booking in car.upcoming_bookings %}
                      <li style="border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:10px 12px;">
                        <div style="display:flex;justify-content:space-between;gap:12px;">
                          <div>
                            <strong>{{ booking.user.get_full_name|default:booking.user.username }}</strong>
                            <div class="muted">{{ booking.start_date }} - {{ booking.end_date }}</div>
                          </div>
                          <span class="chip">{{ booking.status|title }}</span>
                        </div>
                        <div class="muted" style="margin-top:6px;">${{ booking.total_price|default:0 }}</div>
                        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
                          {% if booking.status|lower == "pending" %}
                            <form method="post" action="{% url 'dealer_update_booking_status' booking.id %}">
                              {% csrf_token %}
                              <input type="hidden" name="action" value="confirm">
                              <button class="btn btn-primary btn-sm">Confirm</button>
                            </form>
                            <form method="post" action="{% url 'dealer_update_booking_status' booking.id %}">
                              {% csrf_token %}
                              <input type="hidden" name="action" value="cancel">
                              <button class="btn btn-outline btn-sm">Reject</button>
                            </form>
                          {% endif %}
                          {% if booking.user.email %}
                            <a class="btn btn-secondary btn-sm" href="mailto:{{ booking.user.email }}?subject=Booking for {{ car.title }}">Message</a>
                          {% endif %}
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="muted" style="margin-top:12px;">No upcoming trips.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </details>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted" style="margin-top:12px;">Add a car to see its availability calendar.</p>
  {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
    (function(){
      const panels = document.querySelectorAll('[data-car-schedule]');
      if(!panels.length) return;
      panels.forEach((panel)=>{
        panel.addEventListener('toggle', ()=>{
          if(panel.open){
            panels.forEach((other)=>{ if(other !== panel) { other.removeAttribute('open'); } });
          }
        });
      });
    })();
  </script>
{% endblock %}
